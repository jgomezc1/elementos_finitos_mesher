// GMSH Geometry File - Layered Rectangle
// Auto-generated from: {{ model_name }}
{% if description %}// Description: {{ description }}{% endif %}
// Element size: {{ mesh_size }}

SetFactory("OpenCASCADE");

// Parameters
length = {{ length }};
height = {{ height }};
mesh_size = {{ mesh_size }};

// Layer boundaries (y-coordinates)
{% for layer in layers %}
y_{{ layer.name }} = {{ layer.region[0] }};
{% endfor %}
y_top = {{ height }};

// Bottom boundary points
Point(1) = {0, 0, 0, mesh_size};
Point(2) = {length, 0, 0, mesh_size};

// Layer interface points
{% set point_id = 3 %}
{% for i in range(layers|length - 1) %}
Point({{ point_id }}) = {length, {{ layers[i].region[1] }}, 0, mesh_size};
Point({{ point_id + 1 }}) = {0, {{ layers[i].region[1] }}, 0, mesh_size};
{% set point_id = point_id + 2 %}
{% endfor %}

// Top boundary points
Point({{ point_id }}) = {length, y_top, 0, mesh_size};
Point({{ point_id + 1 }}) = {0, y_top, 0, mesh_size};

// Vertical lines
Line(1) = {1, 2};  // bottom edge
{% set line_id = 2 %}
{% set current_left = 1 %}
{% set current_right = 2 %}
{% for i in range(layers|length) %}
{% set next_left = 2 * i + 4 %}
{% set next_right = 2 * i + 3 %}
{% if i < layers|length - 1 %}
Line({{ line_id }}) = {{ "{" }}{{ current_right }}, {{ next_right }}{{ "}" }};  // right segment {{ i + 1 }}
Line({{ line_id + 1 }}) = {{ "{" }}{{ next_right }}, {{ next_left }}{{ "}" }};  // interface {{ i + 1 }}
Line({{ line_id + 2 }}) = {{ "{" }}{{ next_left }}, {{ current_left }}{{ "}" }};  // left segment {{ i + 1 }}
Line({{ line_id + 3 }}) = {{ "{" }}{{ current_left }}, {{ current_right }}{{ "}" }};  // bottom of layer {{ i + 1 }}
{% set current_left = next_left %}
{% set current_right = next_right %}
{% set line_id = line_id + 4 %}
{% else %}
{# Last layer #}
{% set top_right = 2 * layers|length + 1 %}
{% set top_left = 2 * layers|length + 2 %}
Line({{ line_id }}) = {{ "{" }}{{ current_right }}, {{ top_right }}{{ "}" }};  // right top segment
Line({{ line_id + 1 }}) = {{ "{" }}{{ top_right }}, {{ top_left }}{{ "}" }};  // top edge
Line({{ line_id + 2 }}) = {{ "{" }}{{ top_left }}, {{ current_left }}{{ "}" }};  // left top segment
Line({{ line_id + 3 }}) = {{ "{" }}{{ current_left }}, {{ current_right }}{{ "}" }};  // bottom of top layer
{% endif %}
{% endfor %}

// Surfaces (one per layer)
{% for i in range(layers|length) %}
{% set loop_id = i + 1 %}
{% set first_line = 4 * i + 1 %}
Line Loop({{ loop_id }}) = {{ "{" }}{{ first_line }}, {{ first_line + 1 }}, {{ first_line + 2 }}, {{ first_line + 3 }}{{ "}" }};
Plane Surface({{ loop_id }}) = {{ "{" }}{{ loop_id }}{{ "}" }};
Physical Surface("{{ layers[i].name }}", {{ layers[i].physical_id }}) = {{ "{" }}{{ loop_id }}{{ "}" }};
{% endfor %}

// Physical Lines - map locations to line IDs
{% for bc in boundary_conditions %}
Physical Line("{{ bc.name }}", {{ bc.physical_id }}) = {{ "{" }}{{ bc.line_ids | join(", ") }}{{ "}" }};
{% endfor %}

{% for load in loads %}
Physical Line("{{ load.name }}", {{ load.physical_id }}) = {{ "{" }}{{ load.line_ids | join(", ") }}{{ "}" }};
{% endfor %}

// Mesh generation
{% if mesh_algorithm %}
Mesh.Algorithm = {{ mesh_algorithm }};
{% endif %}
Mesh 2;
